<!-- UJI COBA TFJS MODEL LANGSUNG -->
<!DOCTYPE html>
<html>
<head>
  <title>TFJS Model Inline</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
</head>
<body>
  <script>
    const maxLen = 5;
    const vocab = {};
    let vocabIndex = 1; // Mulai dari 1, karena 0 untuk padding

    const texts = [
      "hai", "halo", "selamat pagi",                 // sapaan
      "apa kabar", "kamu siapa", "jam berapa sekarang", // pertanyaan
      "dadah", "sampai nanti", "selamat tinggal"     // sampai jumpa
    ];

    const labels = [
      0, 0, 0,  // sapaan
      1, 1, 1,  // pertanyaan
      2, 2, 2   // sampai jumpa
    ];

    // Tokenizer sederhana
    function tokenize(text) {
      return text.toLowerCase().split(' ').map(word => {
        if (!vocab[word]) {
          vocab[word] = vocabIndex++;
        }
        return vocab[word];
      });
    }

    function padSequence(seq, maxLen) {
      while (seq.length < maxLen) {
        seq.push(0); // padding
      }
      return seq.slice(0, maxLen); // truncate if longer
    }

    // Tokenisasi dan padding
    const sequences = texts.map(t => padSequence(tokenize(t), maxLen));
    const xs = tf.tensor2d(sequences);
    const ys = tf.tensor1d(labels, 'int32');
    const ysOneHot = tf.oneHot(ys, 3);

    // Buat model
    const model = tf.sequential();
    model.add(tf.layers.embedding({ inputDim: vocabIndex, outputDim: 8, inputLength: maxLen }));
    model.add(tf.layers.flatten());
    model.add(tf.layers.dense({ units: 16, activation: 'relu' }));
    model.add(tf.layers.dense({ units: 3, activation: 'softmax' }));

    model.compile({
      loss: 'categoricalCrossentropy',
      optimizer: 'adam',
      metrics: ['accuracy']
    });

    // Training
    async function trainModel() {
      await model.fit(xs, ysOneHot, {
        epochs: 100,
        callbacks: {
          onEpochEnd: (epoch, logs) => {
            console.log(`Epoch ${epoch + 1}: loss = ${logs.loss.toFixed(4)}, acc = ${logs.acc.toFixed(4)}`);
          }
        }
      });

      // Tes prediksi
      const testText = "anda siapa ya";
      console.log([padSequence(tokenize(testText), maxLen)]);
      // const testSeq = tf.tensor2d([padSequence(tokenize(testText), maxLen)]);
      // const testSeq = tf.tensor2d([[16, 8, 17, 0, 0]]); // the correct
      const testSeq = tf.tensor2d([[16, 8, 17, 0, 0]]);
      console.log("testText: ", testText); // Tensor [[16, 8, 17, 0, 0],]
      testSeq.print();
      const prediction = model.predict(testSeq);
      prediction.print();

      const classIndex = prediction.argMax(-1).dataSync()[0];
      const classes = ["sapaan", "pertanyaan", "sampai jumpa"];
      console.log(`Prediksi: ${classes[classIndex]}`);
    }

    trainModel();
  </script>
</body>
</html>
